#Tá»‡p PHPipAM:
#!/bin/bash
# install-phpipam.sh â€“ Script cÃ i Ä‘áº·t tá»± Ä‘á»™ng phpIPAM cho há»‡ thá»‘ng Debian/Ubuntu
#
# MÃ´ táº£:
# Script nÃ y tá»± Ä‘á»™ng hÃ³a viá»‡c cÃ i Ä‘áº·t vÃ  cáº¥u hÃ¬nh phpIPAM â€“ cÃ´ng cá»¥ quáº£n lÃ½ Ä‘á»‹a chá»‰ IP (IP Address Management)
# mÃ£ nguá»“n má»Ÿ â€“ trÃªn cÃ¡c há»‡ Ä‘iá»u hÃ nh Debian hoáº·c Ubuntu.
# NÃ³ cÃ i Ä‘áº·t Ä‘áº§y Ä‘á»§ LAMP stack (Apache2, MariaDB, PHP 8.2) vÃ  cáº¥u hÃ¬nh phpIPAM vá»›i cÆ¡ sá»Ÿ dá»¯ liá»‡u báº£o máº­t,
# mÃ¡y chá»§ áº£o Apache, cÃ¹ng quy táº¯c tÆ°á»ng lá»­a cÆ¡ báº£n.
# Script sá»­ dá»¥ng tiá»‡n Ã­ch â€˜expectâ€™ Ä‘á»ƒ tá»± Ä‘á»™ng hÃ³a quÃ¡ trÃ¬nh â€˜mysql_secure_installationâ€™, giÃºp cáº¥u hÃ¬nh báº£o máº­t MariaDB:
# Ä‘áº·t máº­t kháº©u root, xoÃ¡ user áº©n danh, táº¯t Ä‘Äƒng nháº­p root tá»« xa, vÃ  xoÃ¡ cÆ¡ sá»Ÿ dá»¯ liá»‡u test.
#
# Há»‡ thá»‘ng há»— trá»£:
# - Debian 11 (Bullseye) trá»Ÿ lÃªn
# - Ubuntu 20.04, 22.04 hoáº·c má»›i hÆ¡n
# - CÃ¡c báº£n phÃ¢n phá»‘i há» Debian cÃ³ apt tÆ°Æ¡ng thÃ­ch
#
# YÃªu cáº§u:
# - Cháº¡y báº±ng quyá»n root (sudo)
# - CÃ³ Internet Ä‘á»ƒ táº£i gÃ³i vÃ  repo phpIPAM tá»« GitHub
# - Há»‡ thá»‘ng sáº¡ch hoáº·c cÃ³ thá»ƒ backup dá»¯ liá»‡u MariaDB cÅ©
# - Cáº§n gÃ³i 'expect' Ä‘á»ƒ tá»± Ä‘á»™ng hoÃ¡ cáº¥u hÃ¬nh MariaDB
#
# Chá»©c nÄƒng chÃ­nh:
# - CÃ i Ä‘áº·t Apache2, MariaDB, PHP 8.2 vÃ  cÃ¡c gÃ³i phá»¥ thuá»™c
# - Backup vÃ  reset dá»¯ liá»‡u MariaDB cÅ©
# - Khá»Ÿi táº¡o dá»¯ liá»‡u vÃ  quyá»n sá»Ÿ há»¯u thÆ° má»¥c MariaDB
# - Tá»± Ä‘á»™ng hoÃ¡ mysql_secure_installation
# - Táº¡o cÆ¡ sá»Ÿ dá»¯ liá»‡u vÃ  tÃ i khoáº£n riÃªng cho phpIPAM
# - Cáº¥u hÃ¬nh Apache Virtual Host vÃ  báº­t rewrite URL
# - Báº­t tÆ°á»ng lá»­a UFW cho SSH + HTTP
# - Clone phpIPAM tá»« GitHub vÃ  cáº¥u hÃ¬nh ban Ä‘áº§u
# - Sinh script háº­u cÃ i Ä‘áº·t Ä‘á»ƒ táº¯t installer web
# - Ghi toÃ n bá»™ log vÃ o 'install-phpipam.log'
#
# CÃ¡ch dÃ¹ng:
#   sudo ./install-phpipam.sh
# Sau Ä‘Ã³ má»Ÿ trÃ¬nh duyá»‡t Ä‘áº¿n http://<ip-server> Ä‘á»ƒ hoÃ n táº¥t qua GUI,
# rá»“i cháº¡y:
#   sudo bash /var/www/html/phpipam/post-gui-setup.sh
#
# Ghi chÃº:
# - Äáº£m báº£o Ä‘á»§ dung lÆ°á»£ng Ä‘Ä©a cho MariaDB
# - Script backup dá»¯ liá»‡u cÅ© vÃ o /var/lib/mysql.bak-<timestamp>
# - CÃ³ thá»ƒ chá»‰nh láº¡i biáº¿n Ä‘áº§u file: DB, máº­t kháº©u, timezone...
# - Kiá»ƒm tra file log náº¿u cÃ i lá»—i
# - Má»™t sá»‘ há»‡ thá»‘ng báº­t AppArmor/SELinux cÃ³ thá»ƒ cáº§n Ä‘iá»u chá»‰nh quyá»n truy cáº­p
#
# TÃ¡c giáº£: [Äiá»n tÃªn báº¡n]
# Cáº­p nháº­t láº§n cuá»‘i: 1/6/2025

set -e
export DEBIAN_FRONTEND=noninteractive

# ----------- CÃC BIáº¾N Cáº¤U HÃŒNH CÃ“ THá»‚ TÃ™Y CHá»ˆNH -----------
IPAM_DB_NAME="phpipam"             # TÃªn cÆ¡ sá»Ÿ dá»¯ liá»‡u phpIPAM
IPAM_DB_USER="phpipamuser"         # TÃªn user MariaDB riÃªng cho phpIPAM
IPAM_DB_PASS="StrongPassword123!"  # Máº­t kháº©u user phpIPAM
MYSQL_ROOT_PASSWORD="MyRootPass123!"   # Máº­t kháº©u root MariaDB
WEB_DIR="/var/www/html/phpipam"    # ÄÆ°á»ng dáº«n cÃ i Ä‘áº·t phpIPAM
TIMEZONE="America/Los_Angeles"     # MÃºi giá» há»‡ thá»‘ng
HOSTNAME="phpipam-server"          # TÃªn mÃ¡y chá»§ (hostname)
LOGFILE="install-phpipam.log"      # File log cÃ i Ä‘áº·t
# ------------------------------------------------------------

# Ghi log ra file vÃ  Ä‘á»“ng thá»i hiá»ƒn thá»‹ trÃªn terminal
exec > >(tee -a "$LOGFILE") 2>&1

echo "==> CÃ i Ä‘áº·t cÃ¡c cÃ´ng cá»¥ cáº§n thiáº¿t..."
sudo apt update && sudo apt install -y expect curl wget nano ufw git unzip net-tools software-properties-common lsb-release ca-certificates apt-transport-https gnupg apache2 mariadb-server

# Kiá»ƒm tra náº¿u Ä‘Ã£ cÃ³ dá»¯ liá»‡u MariaDB
echo "==> Kiá»ƒm tra dá»¯ liá»‡u MariaDB hiá»‡n cÃ³..."
if [ -d "/var/lib/mysql" ]; then
    echo "Cáº£nh bÃ¡o: PhÃ¡t hiá»‡n dá»¯ liá»‡u MariaDB cÅ©. Dá»«ng dá»‹ch vá»¥ vÃ  backup..."
    sudo systemctl stop mariadb || true
    if systemctl is-active --quiet mariadb; then
        echo "Lá»—i: KhÃ´ng thá»ƒ dá»«ng MariaDB. Kiá»ƒm tra log báº±ng 'journalctl -u mariadb'."
        exit 1
    fi
    sudo rm -rf /var/lib/mysql.bak-$(date +%F_%H-%M-%S) || true
    sudo mv /var/lib/mysql /var/lib/mysql.bak-$(date +%F_%H-%M-%S) || {
        echo "Lá»—i: KhÃ´ng thá»ƒ di chuyá»ƒn /var/lib/mysql. Kiá»ƒm tra quyá»n truy cáº­p."
        exit 1
    }
    echo "ÄÃ£ backup dá»¯ liá»‡u MariaDB vÃ o /var/lib/mysql.bak-$(date +%F_%H-%M-%S)"
fi

echo "==> Äáº£m báº£o thÆ° má»¥c dá»¯ liá»‡u MariaDB tá»“n táº¡i..."
sudo mkdir -p /var/lib/mysql
sudo chown mysql:mysql /var/lib/mysql
sudo chmod 700 /var/lib/mysql

# CÃ i Ä‘áº·t láº¡i MariaDB
echo "==> CÃ i Ä‘áº·t MariaDB..."
sudo apt install -y mariadb-server

# Khá»Ÿi táº¡o dá»¯ liá»‡u MariaDB
echo "==> Khá»Ÿi táº¡o dá»¯ liá»‡u MariaDB..."
if [ -z "$(ls -A /var/lib/mysql)" ]; then
    sudo mariadb-install-db --user=mysql --datadir=/var/lib/mysql
    if [ $? -ne 0 ]; then
        echo "Lá»—i: KhÃ´ng thá»ƒ khá»Ÿi táº¡o dá»¯ liá»‡u MariaDB."
        exit 1
    fi
else
    echo "Cáº£nh bÃ¡o: /var/lib/mysql khÃ´ng rá»—ng, Ä‘áº·t láº¡i quyá»n sá»Ÿ há»¯u..."
    sudo chown -R mysql:mysql /var/lib/mysql
    sudo chmod -R 700 /var/lib/mysql
fi

# Báº­t vÃ  khá»Ÿi Ä‘á»™ng MariaDB
echo "==> Báº­t vÃ  khá»Ÿi Ä‘á»™ng MariaDB..."
sudo systemctl enable mariadb
sudo systemctl start mariadb
if ! systemctl is-active --quiet mariadb; then
    echo "Lá»—i: Dá»‹ch vá»¥ MariaDB khÃ´ng khá»Ÿi Ä‘á»™ng Ä‘Æ°á»£c. Kiá»ƒm tra log."
    sudo journalctl -u mariadb -n 50 --no-pager
    exit 1
fi

# Tá»± Ä‘á»™ng hÃ³a mysql_secure_installation
echo "==> Tá»± Ä‘á»™ng hÃ³a mysql_secure_installation..."
sudo expect <<EOD
set timeout 30
spawn mysql_secure_installation
expect {
    "Enter current password for root (enter for none):" {
        send "\r"
        exp_continue
    }
    "Switch to unix_socket authentication" {
        send "n\r"
        exp_continue
    }
    "Change the root password?" {
        send "y\r"
    }
    "Set root password?" {
        send "y\r"
    }
    timeout {
        send_user "Lá»—i: mysql_secure_installation timeout.\n"
        exit 1
    }
}
expect {
    "New password:" { send "$MYSQL_ROOT_PASSWORD\r" }
    timeout { exit 1 }
}
expect {
    "Re-enter new password:" { send "$MYSQL_ROOT_PASSWORD\r" }
    timeout { exit 1 }
}
expect { "Remove anonymous users?" { send "y\r" } }
expect { "Disallow root login remotely?" { send "y\r" } }
expect { "Remove test database and access to it?" { send "y\r" } }
expect { "Reload privilege tables now?" { send "y\r" } }
expect eof
EOD

if [ $? -ne 0 ]; then
    echo "Lá»—i: mysql_secure_installation tháº¥t báº¡i. Kiá»ƒm tra log."
    exit 1
fi

# Kiá»ƒm tra Ä‘Äƒng nháº­p root MariaDB
echo "==> Kiá»ƒm tra Ä‘Äƒng nháº­p MariaDB..."
if ! mysql -u root -p"$MYSQL_ROOT_PASSWORD" -e "SELECT 1" 2>/dev/null; then
    echo "KhÃ´ng thá»ƒ Ä‘Äƒng nháº­p MariaDB báº±ng root. Thá»­ Ä‘áº·t láº¡i máº­t kháº©u..."
    sudo systemctl stop mariadb
    sudo mysqld_safe --skip-grant-tables &
    sleep 5
    mysql -u root <<EOF
FLUSH PRIVILEGES;
ALTER USER 'root'@'localhost' IDENTIFIED BY '$MYSQL_ROOT_PASSWORD';
EOF
    sudo killall mysqld
    sudo systemctl start mariadb
fi

# Táº¡o database phpIPAM
echo "==> Táº¡o database vÃ  user phpIPAM..."
mysql -u root -p"$MYSQL_ROOT_PASSWORD" <<EOF
CREATE DATABASE IF NOT EXISTS $IPAM_DB_NAME;
CREATE USER IF NOT EXISTS '$IPAM_DB_USER'@'localhost' IDENTIFIED BY '$IPAM_DB_PASS';
GRANT ALL PRIVILEGES ON $IPAM_DB_NAME.* TO '$IPAM_DB_USER'@'localhost';
FLUSH PRIVILEGES;
EOF

# Cáº¥u hÃ¬nh hostname vÃ  timezone
echo "==> Äáº·t hostname vÃ  timezone..."
sudo hostnamectl set-hostname "$HOSTNAME"
sudo timedatectl set-timezone "$TIMEZONE"

# Cáº¥u hÃ¬nh tÆ°á»ng lá»­a UFW
echo "==> Thiáº¿t láº­p tÆ°á»ng lá»­a UFW..."
sudo ufw allow OpenSSH
sudo ufw allow 80/tcp
sudo ufw --force enable

# CÃ i PHP 8.2 vÃ  cÃ¡c gÃ³i phá»¥
echo "==> CÃ i Ä‘áº·t PHP 8.2..."
sudo apt purge -y php* libapache2-mod-php || true
sudo add-apt-repository ppa:ondrej/php -y
sudo apt update
sudo apt install -y php8.2 php8.2-mysql php8.2-gd php8.2-curl php8.2-mbstring php8.2-xml php8.2-zip php8.2-gmp php8.2-bcmath php8.2-intl php8.2-cli php-pear libapache2-mod-php8.2
sudo update-alternatives --set php /usr/bin/php8.2

# Táº£i phpIPAM
echo "==> Clone phpIPAM tá»« GitHub..."
cd /var/www/html
sudo rm -rf phpipam
sudo git clone https://github.com/phpipam/phpipam.git
sudo chown -R www-data:www-data phpipam
cd phpipam
sudo cp config.dist.php config.php

# Cáº¥u hÃ¬nh Apache VirtualHost
echo "==> Cáº¥u hÃ¬nh Apache VirtualHost..."
sudo tee /etc/apache2/sites-available/phpipam.conf > /dev/null <<EOF
<VirtualHost *:80>
    DocumentRoot /var/www/html/phpipam
    ServerName phpipam.local

    <Directory /var/www/html/phpipam>
        Options Indexes FollowSymLinks
        AllowOverride All
        Require all granted
    </Directory>
</VirtualHost>
EOF

sudo a2ensite phpipam.conf
sudo a2dissite 000-default.conf
sudo a2enmod rewrite
sudo systemctl reload apache2

# Script háº­u GUI setup
echo "==> Táº¡o script háº­u cÃ i Ä‘áº·t (post-GUI)..."
INSTALL_DIR="/var/www/html/phpipam"
sudo tee "$INSTALL_DIR/post-gui-setup.sh" > /dev/null <<EOP
#!/bin/bash
CONFIG_FILE="/var/www/html/phpipam/config.php"
if [ ! -f "\$CONFIG_FILE" ]; then
    echo "Lá»—i: KhÃ´ng tÃ¬m tháº¥y \$CONFIG_FILE."
    exit 1
fi
if ! sudo test -w "\$CONFIG_FILE"; then
    echo "Lá»—i: KhÃ´ng thá»ƒ ghi vÃ o \$CONFIG_FILE."
    exit 1
fi
if grep -q 'disable_installer' "\$CONFIG_FILE"; then
    sudo sed -i 's/\$disable_installer *= *false;/\$disable_installer = true;/' "\$CONFIG_FILE"
    if grep -q '\$disable_installer = true;' "\$CONFIG_FILE"; then
        echo "ÄÃ£ vÃ´ hiá»‡u hÃ³a trÃ¬nh cÃ i Ä‘áº·t phpIPAM (disable_installer=true)"
    else
        echo "Lá»—i: KhÃ´ng cáº­p nháº­t Ä‘Æ°á»£c disable_installer."
        exit 1
    fi
else
    echo "KhÃ´ng tÃ¬m tháº¥y dÃ²ng disable_installer trong config.php"
    exit 1
fi
EOP

sudo chmod +x "$INSTALL_DIR/post-gui-setup.sh"

# HoÃ n táº¥t
SERVER_IP=$(hostname -I | awk '{print $1}')
echo
echo "ğŸ‰ CÃ€I Äáº¶T HOÃ€N Táº¤T!"
echo "---------------------------------------------"
echo "Truy cáº­p phpIPAM táº¡i: http://$SERVER_IP"
echo
echo "Sau khi hoÃ n táº¥t cáº¥u hÃ¬nh GUI, cháº¡y:"
echo "   sudo bash $INSTALL_DIR/post-gui-setup.sh"
echo "---------------------------------------------"
